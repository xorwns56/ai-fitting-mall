version: '3.8'

services:
  # ===========================================
  # MySQL 데이터베이스
  # ===========================================
  mysql:
    image: mysql:8.0
    container_name: mysql
    ports:
      - "3306:3306"                # 호스트:컨테이너 포트 매핑. 로컬에서 3306으로 접속 가능
    environment:
      MYSQL_ROOT_PASSWORD: 1234    # root 계정 비밀번호
      MYSQL_DATABASE: mydb         # 컨테이너 시작 시 자동 생성할 데이터베이스명
    volumes:
      - mysql-data:/var/lib/mysql/ # 컨테이너 재시작해도 데이터 유지 (Named Volume)
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci  # 한글 깨짐 방지

  # ===========================================
  # Adminer - 웹 기반 DB 관리 도구
  # 접속: http://localhost:8090
  # ===========================================
  adminer:
    image: adminer:latest
    container_name: adminer
    ports:
      - "8090:8080"                # Adminer 기본 포트 8080 → 호스트 8090으로 매핑 (프론트엔드 3000과 충돌 방지)
    depends_on:
      - mysql                      # MySQL이 먼저 실행된 후 시작

  # ===========================================
  # Prometheus - 메트릭 수집 서버
  # 접속: http://localhost:9090
  # Spring Boot Actuator에서 노출한 메트릭을 주기적으로 수집
  # ===========================================
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"                # Prometheus 웹 UI 포트
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml  # 수집 대상 설정 파일 마운트
      - prometheus-data:/prometheus                                         # 수집한 메트릭 데이터 저장소
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'  # 설정 파일 경로 지정
      - '--storage.tsdb.path=/prometheus'               # 시계열 데이터 저장 경로

  # ===========================================
  # Grafana - 메트릭 시각화 대시보드
  # 접속: http://localhost:3001 (admin/admin)
  # Prometheus 데이터를 그래프/차트로 시각화
  # ===========================================
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3001:3000"                # Grafana 기본 3000 → 3001로 변경 (프론트엔드와 충돌 방지)
    environment:
      - GF_SECURITY_ADMIN_USER=admin      # 관리자 계정
      - GF_SECURITY_ADMIN_PASSWORD=admin  # 관리자 비밀번호 (개발용)
    volumes:
      - grafana-data:/var/lib/grafana     # 대시보드 설정 , 데이터소스 설정 유지
    depends_on:
      - prometheus                        # Prometheus가 먼저 실행되어야 데이터소스 연결 가능

  # ===========================================
  # Zipkin - 분산 추적 시스템
  # 접속: http://localhost:9411
  # MSA 환경에서 서비스 간 API 호출 흐름 및 지연시간 분석
  # ===========================================
  zipkin:
    image: openzipkin/zipkin:latest
    container_name: zipkin
    ports:
      - "9411:9411"                # Zipkin 웹 UI 및 API 포트

# ===========================================
# Named Volumes - 컨테이너 삭제해도 데이터 보존
# docker volume ls 로 확인 가능
# ===========================================
volumes:
  mysql-data:        # MySQL 데이터 저장
  prometheus-data:   # Prometheus 메트릭 데이터 저장
  grafana-data:      # Grafana 대시보드/설정 저장
